# WebSocket Architecture (Canon)

_Updated: 2025-09-17_

ClassWaves uses Socket.IO with Redis for real-time communication across two canonical namespaces:

- `/sessions` – session lifecycle, group status, transcription feed, analytics finalized/failed, audio backpressure.
- `/guidance` – teacher guidance streams (Tier1/Tier2 insights, prompts, analytics attention/tier2-shift events).

Redis (`socket.io-redis` adapter) is **mandatory** for multi-process scaling and for worker pods to emit events.

---

## 1. Client Connection

```ts
import { io } from 'socket.io-client';

const token = getJwt();
const wsBase = process.env.NEXT_PUBLIC_WS_URL ?? 'ws://localhost:3000';

const sessionsSocket = io(`${wsBase}/sessions`, {
  auth: { token },
  transports: ['websocket'],
});

const guidanceSocket = io(`${wsBase}/guidance`, {
  auth: { token },
  transports: ['websocket'],
});
```

Tokens are validated per connection; unauthorized connects receive `CONNECT_ERROR` with `code = 'AUTH_FAILED'`.

---

## 2. `/sessions` Namespace

### Client → server events

| Event | Payload | Description |
| --- | --- | --- |
| `session:guidance:subscribe` | `{ sessionId }` | Subscribe to session-specific rooms (transcripts, analytics). |
| `session:guidance:unsubscribe` | `{ sessionId }` | Leave session-specific rooms. |
| `analytics:subscribe` *(legacy)* | `{ sessionId?, metrics? }` | Deprecated (use `/guidance`). Only `analytics:finalized|failed` remain. |
| `audio:stream:ack` | `{ sessionId, groupId }` | Acknowledge stream start for instrumentation. |

> Session lifecycle mutations (start/pause/end) remain **REST-first**. Do not send `session:update_status` events; backend rejects with `UNSUPPORTED_OPERATION`.

### Server → client events

| Event | Payload | Description |
| --- | --- | --- |
| `session:status_changed` | `{ sessionId, status }` | Session transitions (`created`, `active`, `paused`, `ending`, `ended`). |
| `group:status_changed` | `{ groupId, status, isReady, issueReason? }` | Group state (ready, recording, issue). |
| `student:session:joined` | `{ sessionId, studentId }` | A student joined the session. |
| `group:joined` | `{ sessionId, groupId, studentId }` | Student joined group. |
| `transcription:group:new` | `{ sessionId, groupId, text, timestamp, ... }` | Live transcription slices. |
| `analytics:finalized` | `{ sessionId, analyticsId, durationMs, summary }` | Session analytics completed. |
| `analytics:failed` | `{ sessionId, errorCode, message }` | Analytics computation failed. |
| `audio:error` | `{ sessionId, groupId, code }` | Backpressure/lifecycle hints: `SESSION_PAUSED`, `SESSION_ENDING`, `SESSION_NOT_ACTIVE`, `BACKPRESSURE_HINT`. |

The `/sessions` client is the canonical consumer for transcriptions and analytics finalized.

---

## 3. `/guidance` Namespace

### Client → server events

| Event | Payload | Description |
| --- | --- | --- |
| `guidance:subscribe` | `{ subscriptions?: string[] }` | Global subscription (defaults to `['teacher_alerts','recommendations','insights']`). |
| `guidance:unsubscribe` | `{ subscriptions?: string[] }` | Remove global guidance subscriptions. |
| `session:guidance:subscribe` | `{ sessionId }` | Subscribe to session-specific guidance room. |
| `session:guidance:unsubscribe` | `{ sessionId }` | Leave session-specific guidance room. |
| `analytics:subscribe` | `{ sessionId?: string; metrics?: string[] }` | Subscribe to analytics rooms (see below). |
| `analytics:unsubscribe` | `{ sessionId?: string; metrics?: string[] }` | Leave analytics rooms. |
| `prompt:interact` | `{ promptId, action: 'acknowledge'|'use'|'dismiss', feedback?, sessionId? }` | Teacher prompt interactions. |

### Server → client events

| Event | Payload | Description |
| --- | --- | --- |
| `guidance:subscribed` | `{ subscriptions, timestamp }` | Confirmation of global subscription (client updates local state). |
| `session:guidance:subscribed` | `{ sessionId, sessionStatus?, timestamp }` | Confirmation per session. |
| `teacher:alert` | `TeacherPrompt` | Real-time urgent prompts. |
| `teacher:recommendations` | `TeacherPrompt[]` | Batch recommendations generated by auto prompts. |
| `ai:tier1:insight` | `{ sessionId, groupId, insights, timestamp }` | Tier1 insight event. |
| `ai:tier2:insight` | `{ sessionId, groupId, insights, timestamp }` | Tier2 insight event (group-only; session scope deprecated). |
| `prompt:interaction_confirmed` | `{ promptId, action, timestamp }` | Confirmation after backend processes interaction. |
| `guidance:analytics` | `WsGuidanceAnalyticsEvent` | Attention/tier2 shift events (details below). |

### Analytics category rooms

Clients subscribe via `analytics:subscribe` with optional metrics:

```ts
// Default (attention only)
guidanceSocket.emit('analytics:subscribe', { sessionId: 'session-1' });

// Attention + Tier2 shift
guidanceSocket.emit('analytics:subscribe', {
  sessionId: 'session-1',
  metrics: ['attention', 'tier2-shift'],
});
```

Rooms created server-side:

- `analytics:session:<sessionId>:attention`
- `analytics:session:<sessionId>:tier2-shift`
- `analytics:global:<metric>` when `sessionId` omitted.

Events follow `WsGuidanceAnalyticsEvent` (exported from `@classwaves/shared`):

```ts
// Attention event
{
  category: 'attention',
  sessionId,
  metrics: {
    groupId,
    attentionScore: 82,         // integer 0–100
    onTrackScore: 0.63,
    topicalCohesion?: number,
    conceptualDensity?: number,
    offTopicHeat?: number,
    discussionMomentum?: number,
    confusionRisk?: number,
    energyLevel?: number,
  },
  timestamp: new Date().toISOString(),
}

// Tier2 shift event
{
  category: 'tier2-shift',
  sessionId,
  metrics: {
    groupId,
    metric: 'collaborationPatterns',
    previous: 0.72,
    current: 0.54,
    delta: -0.18,
    threshold: -0.15,
  },
  timestamp,
}
```

The frontend stores attention snapshots per group to drive Guidance Heat (Focus Now ≥70, Watch Next 40–69, Stable <40) and lists recent Tier2 shifts.

---

## 4. Redis Keys & TTLs

| Key | Purpose | TTL | Notes |
| --- | --- | --- | --- |
| `guidance:energy:stats:<sessionId>:<groupId>` | Welford stats for energy baseline | `SLI_SESSION_TTL_SECONDS` | Updated by `guidance_energy_welford.lua`. |
| `guidance:prompt:acks:<sessionId>:<groupId>` | Prompt acknowledgements for prompt pressure | Session TTL | Used to compute attention promptPressure. |
| `guidance:attention:last:<sessionId>:<groupId>` | Last attention score/time | `SLI_SESSION_TTL_SECONDS` | Gate threshold via `guidance_attention_gate.lua`. |
| `guidance:autoprompt:last:<sessionId>:<groupId>` | Autoprompt cooldown timestamp | Session TTL + 1h | Maintained by `guidance_autoprompt_cooldown.lua`. |
| `guidance:autoprompt:hashes:<sessionId>:<groupId>` | Prompt dedupe set | Session TTL + 1h | Tracks normalized prompt hashes. |
| `guidance:prompt:template_stats:<templateKey>` | Prompt learning stats | 30 days | Updated via `guidance_prompt_stats.lua`. |
| `guidance:tier2:last:<sessionId>:<groupId>` | Tier2 snapshot | `SLI_SESSION_TTL_SECONDS` | Stores last collaboration/learning/emotional trajectory. |
| `guidance:tier2:shift:last_emit:<sessionId>:<groupId>` | Tier2 shift throttle | 10 minutes | Fail-closed throttle; missing key means emit allowed. |

---

## 5. Worker Emission (Cross-process)

Workers emit to `/guidance` and `/sessions` using the Redis emitter:

```ts
const emitter = createAdapter(redisClient).pubClient;

// Example: emit transcription slice
emitter.emitToNamespace('/sessions', `session:${sessionId}`, 'transcription:group:new', payload);

// Example: emit guidance attention event
emitter.emitToNamespace('/guidance', `analytics:session:${sessionId}:attention`, 'guidance:analytics', analyticsEvent);
```

Ensure worker env has the same `REDIS_URL` and necessary TLS/password options. If emitting via API instead (fallback), ensure API pods subscribe and re-emit.

---

## 6. Frontend Integration Highlights

- `classwaves-frontend/src/lib/websocket/guidance-websocket.service.ts` manages both namespaces; stores analytics subscriptions across reconnects.
- `useTeacherGuidanceWebSocketNamespaced` exposes attention snapshots and tier2 shift events to UI stores/components.
- Guidance Heat uses attention score buckets (Focus Now ≥70, Watch Next 40–69, Stable <40).
- Tier2 shift banners list recent `{ metric, previous, current }` changes per group.

---

## 7. Testing & Troubleshooting

- Unit tests: `classwaves-backend/src/__tests__/unit/services/ai-analysis-trigger.guidance.test.ts`, `teacher-prompt.service.test.ts` cover Lua gates and analytics emission.
- Frontend unit test: `classwaves-frontend/tests/unit/live-group-card.unit.test.tsx` checks Guidance Heat render.
- E2E: Playwright suites confirm transcription, insights, and analytics flows; see repo-level implementation plan.

### Common issues

| Symptom | Likely Cause | Resolution |
| --- | --- | --- |
| No attention events | `GUIDANCE_TIER2_SHIFT_ENABLED`/`GUIDANCE_ATTENTION_*` misconfigured or Redis down | Check Redis keys, metrics `guidance_attention_redis_unavailable_total`. |
| Prompt spam | Cooldown Lua returning fail-open or env `GUIDANCE_AUTOPROMPT_COOLDOWN_MS` too low | Verify Redis availability; review logs/metrics. |
| Tier2 shifts not emitting | `GUIDANCE_TIER2_SHIFT_ENABLED=0` or throttle key set | Toggle flag, clear throttle key for testing. |
| Frontend not reconnecting | Token expired (401 on connection) | Refresh auth token via REST; ensure frontend `getToken` callback updates. |
| Worker emit missing | Redis emitter misconfigured | Ensure same Redis instance and TLS/auth settings. |

---

## 8. References

- Lua scripts: `classwaves-backend/src/redis-scripts/*.lua`
- Backend services: `ai-analysis-trigger.service.ts`, `teacher-prompt.service.ts`, `guidance-namespace.service.ts`
- Frontend guidance hook: `classwaves-frontend/src/features/teacher-guidance/hooks/use-teacher-guidance-websocket-namespaced.ts`
- Shared types: `@classwaves/shared/src/types/ws.events.ts`

